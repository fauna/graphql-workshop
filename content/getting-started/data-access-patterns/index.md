---
title: "Data access patterns"
date: 2021-10-13T13:35:32-04:00
draft: false
weight: 30
pre: "<b>b. </b>"
disableMermaid: false
---

In the previous section, you learn how to set up an entire GraphQL service by uploading a schema to Fauna. In this section, you learn about various data access patterns in Fauna. You also learn how to create your own custom resolvers in Fauna using user-defined functions (UDF).

The following diagram demonstrates the relationship between data in a simple multi-vendor e-commerce application (similar to Shopify).


{{< mermaid >}}
erDiagram
    OWNER ||--O{ STORE : has
    OWNER {
        string name
        string email
        reference stores
    }
    STORE {
        string name
        string paymentMethods
        string categories
        string email
        reference owner
    }
{{< /mermaid >}}

In your database, you have a collection of owners and stores. Each owner can have multiple stores and every store belongs to one owner. This is a classic example of a one-to-many relationship.

You can define this relationship of data with the following GraphQL schema.

{{< tabs groupId="query-language" >}}
{{% tab name="GraphQL" %}}
```graphql
type Owner {
    name: String!
    email: String!
    stores: [Store]! @relation
}

type Store {
    name: String!
    email: String!
    paymentMethods: [String]
    categories: [String]
    owner: Owner!
}
```
{{% /tab %}}
{{< /tabs >}}

Navigate to the GraphQL section in Fauna dashboard. Select *Replace Schema* and upload [this schema](./schemas/schema.graphql) to your database.

Open the docs tabs in your GraphQL playground. Notice Fauna has autogenerated some queries and mutations for you based on your schema. 

{{< figure
  src="./images/5.png" 
  alt="GraphQL Playground docs tab. Review auto generated queries"
>}}

Use the createOwner mutation to create a couple of owners. Run the following mutation in the playground to create a new owner.

{{< tabs groupId="query-language" >}}
{{% tab name="GraphQL" %}}
```graphql
mutation {
  createOwner(data: {
    name: "Jon"
    email: "jon@email.com"
  }) {
    _id
    email
    name
  }
}
```
{{% /tab %}}
{{< /tabs >}}


{{< tabs groupId="output-format" >}}
{{% tab name="JSON" %}}
```json
// Response
{
  "data": {
    "createOwner": {
      "_id": "311680391443382851",
      "email": "jon@email.com",
      "name": "Jon"
    }
  }
}
```
{{% /tab %}}
{{< /tabs >}}

{{% notice note %}}
*You can use the plus tab in GraphQL playground to open multiple tabs. It allows users to keep query/mutation results open to return to later.*
{{% /notice %}}

{{< figure
  src="./images/6.png" 
  alt="GraphQL Playground docs tab. Review auto generated queries"
>}}

Create a new store by running the following mutation. In the owner field reference one of the owners you created in the previous mutation by replacing `<owner-id>` with the value of `_id` returned in your mutation. 

{{< tabs groupId="query-language" >}}
{{% tab name="GraphQL" %}}
```graphql
mutation {
  createStore(data: {
    name: "Forever 23"
    email: "forever23@email.com"
    paymentMethods: ["Paypal", "Credit Card"]
    categories: ["Clothes", "Accessories"]
    owner: {
      connect: "<owner-id>"
    }
  }) {
    _id
    name
  }
}
```
{{% /tab %}}
{{< /tabs >}}

{{< tabs groupId="output-format" >}}
{{% tab name="JSON" %}}
```json
// Response
{
  "data": {
    "createStore": {
      "_id": "311680702751965764",
      "name": "Forever 23"
    }
  }
}
```
{{% /tab %}}
{{< /tabs >}}

Notice the [connect](https://docs.fauna.com/fauna/v4/api/graphql/relations#connect) keyword in the previous code. The connect keyword creates a relationship between models. 

{{% notice note %}}
By design, Fauna combines the simplicity of a document database with the ability to model complex relationships like those in SQL databases. 
{{% /notice %}}

Navigate to *Indexes* in the dashboard. Notice a new `index owner_stores_by_owner` is created based on the GraphQL schema. This particular index is defining the relationship (one to many) between the Owners and Stores. In Fauna you use indexes to retrieve documents by their attributes (other than [Reference](https://docs.fauna.com/fauna/current/learn/understanding/types?lang=shell)). 

{{< figure
  src="./images/7.png" 
  alt="Indexes"
>}}

If you are familiar with a SQL-based database think of this index as a foreign key join. This index allows you to find an Owner and return all the stores associated with that owner.


{{% expand %}}
TODO: Sneak Peak to Searching Indexes
{{% /expand %}}

### Get Owner by ID

The following query finds an owner and all the stores associated with the owner.

{{< tabs groupId="query-language" >}}
{{% tab name="GraphQL" %}}
```graphql
{
  findOwnerByID(id: "<owner-id>") {
    _id
    email
    name
    stores {
      data {
        _id
        name
        paymentMethods
      }
    }
  }
}
```
{{% /tab %}}
{{< /tabs >}}

{{< tabs groupId="output-format" >}}
{{% tab name="JSON" %}}
```json
// Response
{
  "data": {
    "findOwnerByID": {
      "_id": "310939720261567043",
      "email": "john@fauna.com",
      "name": "John Doe",
      "stores": {
        "data": [
          {
            "_id": "310940117104591428",
            "name": "Coffee24/7",
            "paymentMethods": [
              "Credit Card",
              "Paypal"
            ]
          }
        ]
      }
    }
  }
}
```
{{% /tab %}}
{{< /tabs >}}

### Get Owner by Email

You can query documents by any attribute (other than ID). In Fauna there are a couple of ways to query documents by attribute. 

##### Method 1: Let Fauna handle the index creation

The easiest way is to define a query and specify the name of the attribute you are trying to query. Fauna will automatically generate an index for you to find documents by that attribute. Add the following changes to query Owner by email.

{{< tabs groupId="query-language" >}}
{{% tab name="GraphQL" %}}
```graphql
type Query {
  findOwnerByEmail(email: String): [Owner]
}
```
{{% /tab %}}
{{< /tabs >}}

Navigate to *GraphQL* in Fauna dashboard and select *Replace Schema*. Upload the updated schema.

{{% notice note %}}
You will get a warning stating *‚Äúunderlying data may no longer work with existing queries‚Äù*. You can ignore this warning and select Replace.
{{% /notice %}}

{{< figure
  src="./images/9.png" 
  alt="replace schema"
>}}


{{< figure
  src="./images/8.png" 
  alt="warning message"
>}}

Navigate to *Indexes* from Fauna dashboard and notice that Fauna also generates a new index `findOwnerByEmail`.

{{< figure
  src="./images/10.png" 
  alt="Generated index"
>}}

##### Method 2: Define index with `@index` directive

The previous method is a shorthand for this method. You can specify the index with `@index` directive in your schema. Using the @index gives your the flexibility to give custom names to your indexes as well. The following code snippet is demostrates an example of `@index`.

{{< tabs groupId="query-language" >}}
{{% tab name="GraphQL" %}}
```graphql
type Query {
  findOwnerByEmail(email: String): [Owner] @index(name: "getByEmail")
}
```
{{% /tab %}}
{{< /tabs >}}

Navigate back to *GraphQL playground*. Run the following query to find an owner by email.

{{< tabs groupId="query-language" >}}
{{% tab name="GraphQL" %}}
```graphql
{
  findOwnerByEmail(email: "john@fauna.com") {
    data {
      _id
      name
      email
    }
  }
}
```
{{% /tab %}}
{{< /tabs >}}

{{< tabs groupId="output-format" >}}
{{% tab name="JSON" %}}
```json
// response
{
  "data": {
    "findOwnerByEmail": {
      "data": [
        {
          "_id": "310939720261567043",
          "name": "John Doe",
          "email": "john@fauna.com"
        }
      ]
    }
  }
}
```
{{% /tab %}}
{{< /tabs >}}

### Get All Owners

You are now familiar with two common data access patterns `getById` and `getByAttribute`. You can find a particular document by id or find documents by property. However, what if you want to get all the documents (or first 100 documents). Fauna doesn't auto generate a resolver to list all the documents. Fauna provides you with the flexibility to create your own resolvers and run business logic inside the data layer. Let‚Äôs take a look at how you can create a custom resolvers to query all documents.

{{% notice note %}}
üí° *__A resolver is a function that's responsible for populating the data for a single field in your schema.__*¬†*Whenever a client queries for a particular field, the resolver for that field fetches the requested data from the appropriate data source (i.e. Fauna).* - [Apollo GraphQL](http://www.apollographql.com)
{{% /notice %}}


When you create a GraphQL service you create resolver functions in your application layer. In a  typical GraphQL server a resolver function retrieves data from a database, performs the business logic in the application layer and returns a response. The following diagram demonstrates a traditional GraphQL server data flow.

{{< mermaid >}}
sequenceDiagram
    Client-App->>+GraphQL-Server: Client request to GraphQL server
    GraphQL-Server->>+Database: GraphQL server request for data
    Database-->>-GraphQL-Server: Data is returned
    GraphQL-Server-->>-Client-App: GraphQL server runs business logic and returns response 

{{< /mermaid >}}

In every GraphQL server you are querying the data from a database. There is always a slight delay in data retention. In Fauna, there is no application layer. Fauna exposes native GraphQL directly to the client. The resolver functions runs within database layer. You write the resolvers with Fauna's native FQL language. The following diagram demonstrates Fauna's data flow.

{{< mermaid >}}
graph TD
    A[Client Application] --> B(Fauna GraphQL Interface)
    B --> C{Business Logic with FQL resolvers}
    C-->B
    B-->A
{{< /mermaid >}}


Navigate to the *Functions* tab in the dashboard and select *New Function* to create a new UDF. Name your UDF `ListAllOwners`. Copy and paste the following code in the *Function Body* section, and choose *Save* to create your function.

{{< tabs groupId="query-language" >}}
{{% tab name="FQL" %}}
```FQL
Query(
  Lambda(
    [],
    Map(
      Paginate(
        Documents(Collection("Owner"))
      ),
      Lambda("ref", Get(Var("ref")))
    ),
  )
)
```
{{% /tab %}}
{{< /tabs >}}

{{< figure
  src="./images/11.png" 
  alt="UDF function"
>}}

You can leave the role option as none for now. This causes the UDF to run with the same permissions as the identity that invokes it. You learn more about roles in the [authentication and authorization](/) section. 

Add a new query called `listOwners` to your GraphQL schema. Add the `ListAllOwners` UDF as your `@relation` directive.

{{< tabs groupId="query-language" >}}
{{% tab name="GraphQL" %}}
```graphql
type Query {
  findOwnerByEmail(email: String): [Owner] @relation(name: "OwnerByEmail")
  listOwners: [Owner] @relation(name: "ListAllOwners")
}
```
{{% /tab %}}
{{< /tabs >}}

Replace your old schema with the new one. Review the *Docs* section of your GraphQL playground. Notice a `listOwners` query is added.  

{{< figure
  src="./images/12.png" 
  alt="listOwners query"
>}}

 Run the following query to list all owners.

{{< tabs groupId="query-language" >}}
{{% tab name="GraphQL" %}}
```graphql
{
  listOwners {
    data {
      _id
      name
      email
    }
  }
}
```
{{% /tab %}}
{{< /tabs >}}

{{< tabs groupId="output-format" >}}
{{% tab name="JSON" %}}
```json
// response
{
  "data": {
    "listOwners": {
      "data": [
        {
          "_id": "310939656736735811",
          "email": "shadid@fauna.com"
        },
        {
          "_id": "310939720261567043",
          "email": "john@fauna.com"
        }
      ]
    }
  }
}
```
{{% /tab %}}
{{< /tabs >}}

To re-iterate, in this section you learned

1. How to access a document by ID in Fauna
1. How to access documents by custom properties
1. How to define indexes with `@index` directive
1. How resolvers work in Fauna
1. How to create custom resolvers and UDFs

That's a wrap for this section. In the next section, you learn all about user authentication in Fauna.